<template>
  <div v-highlight class="codeWrapper">
    <transition
        v-on:before-enter="beforeEnter"
        v-on:enter="enter"
        v-on:leave="leave"
    >
      <pre v-show="codeVisible" ref="code">
        <span v-if="title" class="title">{{ title }}</span>
        <code>{{ code }}</code>
      </pre>
    </transition>
    <div class="codeExpand" @click="toggleCodeVisible">
      <b :class="{ expand: codeVisible }">ü°á</b>
      <span>{{ codeVisible ? 'ÈöêËóè‰ª£Á†Å' : 'ÊòæÁ§∫‰ª£Á†Å' }}</span>
    </div>
  </div>
</template>

<script>
import hljs from 'highlight.js'
import 'highlight.js/styles/monokai-sublime.css'
import Velocity from 'velocity-animate'

export default {
  name: 'CodeBar',
  props: {
    code: String,
    title: String,
  },
  directives: {
    highlight: {
      inserted: function (el) {
        let blocks = el.querySelectorAll('pre code');
        blocks.forEach((block)=>{
          hljs.highlightBlock(block)
        })
      }
    }
  },
  data () {
    return {
      codeVisible: true,
    }
  },
  mounted () {
    const { height } = this.$refs.code.getBoundingClientRect()
    this.height = height + 'px'
    this.codeVisible = false
  },
  methods: {
    toggleCodeVisible () {
      this.codeVisible = !this.codeVisible
    },
    beforeEnter (el) {
      el.style.opacity = '0'
      el.style.height = '0'
    },
    enter (el) {
      Velocity(el, { opacity: 1, height: this.height }, { duration: 300 })
    },
    leave (el, done) {
      Velocity(el, {
        height: 0,
        opacity: 0
      }, { complete: done })
    }
  },
}
</script>

<style lang="less" scoped>
.codeWrapper {
  border-top: 1px solid #ebebeb;
  margin-top: 24px;
  > pre {
    margin: 0;
    border-radius: 0;
    box-sizing: border-box;
    padding-top: 0;
    padding-bottom: 0;
    opacity: 0;
    overflow: hidden;
  }
}
.title {
  margin: 0;
  padding: 10px 12px;
  box-sizing: border-box;
  border: 1px solid #ebebeb;
  border-radius: 3px;
  color: #ebebeb;
  font-size: 12px;
  display: block;
}
.codeExpand {
  text-align: center;
  display: flex;
  align-items: center;
  height: 3em;
  cursor: pointer;
  justify-content: center;
  > svg, > b {
    color: #d3dce6;
    transition: all .2s;
    &.expand {
      transform: rotate(180deg);
    }
  }
  span {
    display: inline-block;
    transition: all .3s;
    width: 0;
    opacity: 0;
    white-space:nowrap;
    margin-left: 1em;
    overflow:hidden;
  }
  &:hover {
    svg {
      fill: #409eff;
    }
    span {
      color: #409eff;
      width: 4em;
      opacity: 1;
    }
  }
}
</style>
